<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>XML Bible Demo - Isaiah Tanner</title>
<script type="text/javascript">

function setup() {
  if (window.XMLHttpRequest)
    xmlhttp = new XMLHttpRequest();
  else
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
  biblePath = "/class/csc3004/XMLBible/";
}

var str; //strongs variable

function getresponse() {
  var b = document.getElementById('book').value;
  var c = document.getElementById('chapter').value;
  var v = parseInt(document.getElementById('verse').value);
  var chapNum = parseInt(c);
  var verseNum = parseInt(document.getElementById('numOfVerse').value);
  var ver = document.querySelector('input[name = "version"]:checked');
  str = document.querySelector('input[name = "strongs"]:checked');

  if (ver == null){
      alert("Please select a book version");
      return;
  }
  else if (ver.value == "kjv")
      var XMLBook = biblePath + "kjv_by_book/" + b + ".xml";
  else if (ver.value == "web")
      var XMLBook = biblePath + "web_by_book/" + b + ".xml";
  else
      alert("I don't know how you broke this");

  if (str == null){
      alert("Please select whether or not to include strongs");
      return;
  }

  xmlhttp.open("GET",XMLBook,false);
  xmlhttp.send();
  xmlDoc = xmlhttp.responseXML;

  var bookInfo = "<h6>Book retrieved from file: " + XMLBook + "</h6>";
  document.all.headArea.innerHTML = "<h1><font color=blue>XML Bible Demo Output</font></h1>" + bookInfo;

  try {
    document.all.responseArea.innerHTML = " ";
    vtext = getVerse(b,c,v);
	document.all.responseArea.innerHTML += "<p>" +vtext+ "</p>";

	v++;
	verseNum--;
  }
  catch(error) {
    if (error == "no chapter")
      document.all.responseArea.innerHTML += "<b><i>No such chapter " +c+ "</i></b>";
    if (error == "no verse")
        document.all.responseArea.innerHTML += "<b><i>No such verse " +v+ "</i></b>";
  }

  while (verseNum > 0){ // Number of verse logic
      try {
          document.all.responseArea.innerHTML = " ";
          vtext += getVerse(b, chapNum, v);
          document.all.responseArea.innerHTML += "<p>" +vtext+ "</p>";

          v++;
          verseNum--;
      }
      catch (error) {
      if (error == "no chapter")
          document.all.responseArea.innerHTML += "<b><i>No such chapter " +c+ "</i></b>";
      if (error == "no verse")
          chapNum++; v = 1; // Advance to next chapter on verse overrun
      }
    }
}

function getVerse(book, chapter, verse) {
  var verseOutput = xmlDoc.getElementsByTagName("book")[0].getAttribute("name"); 
  var c = xmlDoc.getElementsByTagName("chapter")[chapter-1];

  if (c==null)
	throw "no chapter";

  verseOutput += " ";
  verseOutput += c.getAttribute("number");

  var v = c.getElementsByTagName("verse")[verse-1]

  if (v==null)
	throw "no verse";

  verseOutput += ":";
  verseOutput += v.getAttribute("number");
  verseOutput += " - ";

  for (j=0; j < v.childNodes.length; j++) {
	var nodeStr = getNodeString(v.childNodes[j]);
	verseOutput += nodeStr;
  }
  return(verseOutput);
}

function getNodeString(node) {
	var result = "";

	if (node.nodeType == 3) { // type 3: text node
		result += node.nodeValue;
		result += " ";
	}

	if (node.nodeType == 1) { // type 1: tag
		if (node.nodeName == "em") {
		   result += "<i>";
		   result += node.childNodes[0].nodeValue;
		   result += "</i> ";
		}

		else if (node.nodeName == "STYLE") {
		   result += '<span style="' + node.getAttribute("css") + '">';
		   for (n=0; n < node.childNodes.length; n++) {
				var nodeStr = getNodeString(node.childNodes[n]);
				result += nodeStr;
			}

		   result += "</span> ";
		}

		else if (node.nodeName=="strongs") {
		   if (node.childNodes[0] != null)
			 result += node.childNodes[0].nodeValue;
		   if (node.hasAttribute("hebrew") == true && str.value =="true"){
               var strong = node.getAttribute("hebrew");
               result = result + "<a href='javascript:alert(" + strong + ")'>" + "<a href='javascript:showStrongs(" + strong + ",\"hebrew\")'>"
                   + "<i><font size=1 color=blue><sub>" + node.getAttribute("hebrew") + "</sub></font></i></a> ";
           }
		   if (node.hasAttribute("greek") == true && str.value =="true"){
               var strong = node.getAttribute("greek");
               result = result + "<a href='javascript:alert(" + strong + ")'>" + "<a href='javascript:showStrongs(" + strong + ",\"greek\")'>"
                   + "<i><font size=1 color=blue><sub>" + node.getAttribute("greek") + "</sub></font></i></a> ";
		   }
	   }
	}
	return(result);
}

</script>
</head>
<body onLoad="setup()">
<form onsubmit="return false">
<h1>Bible XML Search</h1>
<table>
    <TR>
        <h3>Bible Version</h3>
        <TD ALIGN=LEFT VALIGN=TOP><input type="radio" name="version" value="kjv">King James Version</TD>
        <TD ALIGN=LEFT VALIGN=TOP><input type="radio" name="version" value="web">Web English Bible</TD>
    </TR>
    <TR>
        <TD ALIGN=RIGHT VALIGN=TOP>Book Number</TD>
        <TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="book" TYPE="text" MAXLENGTH=2  id=book></TD>
    </TR>
    <TR>
        <TD ALIGN=RIGHT VALIGN=TOP>Chapter</TD>
        <TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="chapter" TYPE="text" MAXLENGTH=3  id=chapter></TD>
    </TR>
    <TR>
        <TD ALIGN=RIGHT VALIGN=TOP>Verse</TD>
        <TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="verse" TYPE="text" MAXLENGTH=3 id=verse></TD>
    </TR>
    <TR>
        <TD ALIGN=RIGHT VALIGN=TOP>Number of Verses</TD>
        <TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="numOfVerse" TYPE="text" MAXLENGTH=3 id=numOfVerse></TD>
    </TR>
    <TR>
        <TD ALIGN=LEFT VALIGN=TOP><input type="radio" name="strongs" value="true">Include Strong's Lexicon</TD>
    </TR>
</table>
<p>
    <input type="submit" onclick="javascript: getresponse()" name="submit" value="Submit" />
</p>
</form>
<div id = "headArea"></div>
<div id = "responseArea"></div>
</body>
</html>